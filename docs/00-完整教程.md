# DiT æ–‡ç”Ÿå›¾å®Œæ•´æ•™ç¨‹

## ğŸ“š ç›®å½•

1. [é¡¹ç›®ä»‹ç»](#é¡¹ç›®ä»‹ç»)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
4. [æ•°æ®å‡†å¤‡](#æ•°æ®å‡†å¤‡)
5. [æ¨¡å‹è®­ç»ƒ](#æ¨¡å‹è®­ç»ƒ)
6. [æ¨¡å‹æ¨ç†](#æ¨¡å‹æ¨ç†)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
9. [è¿›é˜¶å­¦ä¹ ](#è¿›é˜¶å­¦ä¹ )

---

## é¡¹ç›®ä»‹ç»

### ä»€ä¹ˆæ˜¯ DiTï¼Ÿ

DiT (Diffusion Transformer) æ˜¯ä¸€ç§ç»“åˆäº†æ‰©æ•£æ¨¡å‹å’Œ Transformer æ¶æ„çš„æ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ–‡æœ¬æè¿°ç”Ÿæˆé«˜è´¨é‡çš„å›¾åƒã€‚

### é¡¹ç›®ç‰¹ç‚¹

- âœ… **åŸºäº Hugging Face** - ä½¿ç”¨æ ‡å‡†åŒ–çš„ Hugging Face ç”Ÿæ€ç³»ç»Ÿ
- âœ… **å°æ¨¡å‹é…ç½®** - é€‚é… RTX 4090ï¼Œä½¿ç”¨å°æ¨¡å‹å’Œå°æ•°æ®é›†
- âœ… **å®Œæ•´å¯è¿è¡Œ** - ç¡®ä¿èƒ½å¤ŸæˆåŠŸè®­ç»ƒå’Œç”Ÿæˆå›¾åƒ
- âœ… **è¯¦ç»†æ–‡æ¡£** - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†è¯´æ˜
- âœ… **æ˜“äºå­¦ä¹ ** - ä»£ç æ³¨é‡Šæ¸…æ™°ï¼Œç»“æ„æ¨¡å—åŒ–

### æŠ€æœ¯æ ˆ

- **PyTorch** - æ·±åº¦å­¦ä¹ æ¡†æ¶
- **Hugging Face Diffusers** - æ‰©æ•£æ¨¡å‹åº“
- **Hugging Face Transformers** - Transformer æ¨¡å‹åº“
- **Hugging Face Accelerate** - è®­ç»ƒåŠ é€Ÿ
- **Hugging Face Datasets** - æ•°æ®é›†ç®¡ç†

---

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
conda create -n dit python=3.10
conda activate dit

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. å‡†å¤‡æ•°æ®

```bash
# å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆ100ä¸ªæ ·æœ¬ï¼‰
python src/scripts/prepare_data.py \
    --type coco \
    --output ./data/test_data \
    --num_samples 100
```

### 3. å¼€å§‹è®­ç»ƒ

```bash
# ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®è®­ç»ƒ
python src/scripts/train.py --config configs/train_config.yaml
```

### 4. ç”Ÿæˆå›¾åƒ

```bash
# ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹ç”Ÿæˆå›¾åƒ
python src/scripts/inference.py \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a cat sitting on a chair"
```

---

## ç¯å¢ƒé…ç½®

### ç³»ç»Ÿè¦æ±‚

**ç¡¬ä»¶ï¼š**
- GPU: NVIDIA GPUï¼ˆæ¨è RTX 4090 æˆ–æ›´é«˜ï¼‰
- æ˜¾å­˜: è‡³å°‘ 24GB
- å†…å­˜: è‡³å°‘ 16GB RAM
- å­˜å‚¨: è‡³å°‘ 50GB å¯ç”¨ç©ºé—´

**è½¯ä»¶ï¼š**
- Python: 3.8+ï¼ˆæ¨è 3.9 æˆ– 3.10ï¼‰
- CUDA: 11.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- æ“ä½œç³»ç»Ÿ: Linuxï¼ˆæ¨èï¼‰æˆ– Windows

### å®‰è£…æ­¥éª¤

#### 1. å®‰è£… Python

```bash
# ä½¿ç”¨ condaï¼ˆæ¨èï¼‰
conda create -n dit python=3.10
conda activate dit
```

#### 2. å®‰è£… PyTorch

```bash
# CUDA 11.8
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

#### 3. å®‰è£…é¡¹ç›®ä¾èµ–

```bash
cd /path/to/t2i2
pip install -r requirements.txt
```

#### 4. éªŒè¯å®‰è£…

```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
```

---

## æ•°æ®å‡†å¤‡

### æ•°æ®æ ¼å¼è¦æ±‚

DiT æ¨¡å‹éœ€è¦**å›¾åƒ-æ–‡æœ¬å¯¹**æ•°æ®ï¼š
- **å›¾åƒ**: RGB æ ¼å¼ï¼Œæ¨èå°ºå¯¸ 256x256 æˆ–æ›´å¤§
- **æ–‡æœ¬**: è‹±æ–‡æè¿°ï¼Œé•¿åº¦å»ºè®® 10-100 ä¸ªè¯

### å‡†å¤‡æ•°æ®

#### æ–¹æ³•1: ä½¿ç”¨ COCO å­é›†ï¼ˆæ¨èç”¨äºå­¦ä¹ ï¼‰

```bash
python src/scripts/prepare_data.py \
    --type coco \
    --output ./data/coco_subset \
    --num_samples 5000
```

#### æ–¹æ³•2: ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®é›†

**æ•°æ®ç›®å½•ç»“æ„ï¼š**
```
custom_data/
â”œâ”€â”€ image1.jpg
â”œâ”€â”€ image1.txt
â”œâ”€â”€ image2.jpg
â”œâ”€â”€ image2.txt
â””â”€â”€ ...
```

**è¿è¡Œè„šæœ¬ï¼š**
```bash
python src/scripts/prepare_data.py \
    --type custom \
    --input ./custom_data \
    --output ./data/custom
```

### æ•°æ®æ ¼å¼

é¡¹ç›®ä½¿ç”¨ JSON æ ¼å¼å­˜å‚¨å…ƒæ•°æ®ï¼š

```json
[
    {
        "image": "images/image_000001.jpg",
        "text": "a cat sitting on a chair"
    }
]
```

**ç›®å½•ç»“æ„ï¼š**
```
data/
â”œâ”€â”€ metadata.json
â””â”€â”€ images/
    â”œâ”€â”€ image_000001.jpg
    â””â”€â”€ ...
```

---

## æ¨¡å‹è®­ç»ƒ

### è®­ç»ƒé…ç½®

å½“å‰æœ€ä¼˜é…ç½®ï¼ˆ`configs/train_config.yaml`ï¼‰ï¼š

```yaml
# æ¨¡å‹é…ç½®
model:
  hidden_size: 768
  num_layers: 16
  num_heads: 12

# è®­ç»ƒé…ç½®
training:
  batch_size: 96  # æ˜¾å­˜åˆ©ç”¨ç‡ 83.6%
  mixed_precision: "bf16"  # BF16 æ›´ç¨³å®š
  num_epochs: 200  # æ¨èå€¼
  learning_rate: 0.0001
```

### å¼€å§‹è®­ç»ƒ

#### åŸºæœ¬è®­ç»ƒ

```bash
python src/scripts/train.py --config configs/train_config.yaml
```

#### æ¢å¤è®­ç»ƒ

```bash
python src/scripts/train.py \
    --config configs/train_config.yaml \
    --resume ./outputs/checkpoint-5000
```

### è®­ç»ƒå‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `batch_size` | 96 | æ‰¹æ¬¡å¤§å°ï¼ˆæ˜¾å­˜åˆ©ç”¨ç‡ 83.6%ï¼‰ |
| `num_epochs` | 200 | è®­ç»ƒè½®æ•°ï¼ˆæ¨è 100-200ï¼‰ |
| `learning_rate` | 0.0001 | å­¦ä¹ ç‡ |
| `mixed_precision` | bf16 | æ··åˆç²¾åº¦ï¼ˆBF16 æ›´ç¨³å®šï¼‰ |
| `num_workers` | 8 | æ•°æ®åŠ è½½çº¿ç¨‹æ•° |
| `compile_model` | true | æ¨¡å‹ç¼–è¯‘ä¼˜åŒ– |

### è®­ç»ƒç›‘æ§

#### æŸ¥çœ‹æ—¥å¿—

è®­ç»ƒæ—¥å¿—ä¿å­˜åœ¨ï¼š`outputs/train.log`

#### ç›‘æ§ GPU

```bash
# å®æ—¶ç›‘æ§
watch -n 1 nvidia-smi

# æˆ–
nvidia-smi -l 1
```

**ç†æƒ³çŠ¶æ€ï¼š**
- æ˜¾å­˜åˆ©ç”¨ç‡: 80-85%
- GPU åˆ©ç”¨ç‡: 80-95%
- è®­ç»ƒé€Ÿåº¦: ~40-50 ms/æ‰¹æ¬¡

### è®­ç»ƒæ—¶é—´ä¼°ç®—

å¯¹äº 5000 æ ·æœ¬ï¼Œæ‰¹æ¬¡ 96ï¼š

- **50 epochs**: ~3 å°æ—¶
- **100 epochs**: ~6 å°æ—¶
- **200 epochs**: ~12 å°æ—¶ï¼ˆæ¨èï¼‰

---

## æ¨¡å‹æ¨ç†

### åŸºæœ¬æ¨ç†å‘½ä»¤

```bash
python src/scripts/inference.py \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a cat sitting on a chair"
```

### å®Œæ•´å‚æ•°ç¤ºä¾‹

```bash
python src/scripts/inference.py \
    --config configs/train_config.yaml \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a beautiful landscape with mountains" \
    --output ./outputs/generated \
    --num_inference_steps 50 \
    --height 256 \
    --width 256 \
    --seed 42
```

### æ¨ç†å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--checkpoint` | å¿…éœ€ | æ¨¡å‹æ£€æŸ¥ç‚¹è·¯å¾„ |
| `--prompt` | å¿…éœ€ | æ–‡æœ¬æç¤º |
| `--num_inference_steps` | 50 | æ¨ç†æ­¥æ•°ï¼ˆ20-100ï¼‰ |
| `--height` | 256 | å›¾åƒé«˜åº¦ |
| `--width` | 256 | å›¾åƒå®½åº¦ |
| `--seed` | None | éšæœºç§å­ï¼ˆå¯é‡å¤ç»“æœï¼‰ |

### æ¨ç†ç¤ºä¾‹

#### å¿«é€Ÿæµ‹è¯•ï¼ˆ20æ­¥ï¼‰

```bash
python src/scripts/inference.py \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a cat" \
    --num_inference_steps 20
```

#### é«˜è´¨é‡ç”Ÿæˆï¼ˆ100æ­¥ï¼‰

```bash
python src/scripts/inference.py \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a cat sitting on a chair" \
    --num_inference_steps 100
```

### æç¤ºè¯æŠ€å·§

**å¥½çš„æç¤ºè¯ï¼š**
- å…·ä½“æè¿°: "a red cat sitting on a wooden chair"
- åŒ…å«ç»†èŠ‚: "a cat with green eyes, sitting on a chair, indoor lighting"
- æŒ‡å®šé£æ ¼: "a cat sitting on a chair, oil painting style"

**æç¤ºè¯æ¨¡æ¿ï¼š**
```
[ä¸»ä½“] + [åŠ¨ä½œ/çŠ¶æ€] + [ç¯å¢ƒ] + [é£æ ¼/è´¨é‡]
```

ç¤ºä¾‹ï¼š
- "a cat sitting on a chair, indoor, photorealistic"
- "a landscape with mountains, sunset, oil painting"

---

## æ€§èƒ½ä¼˜åŒ–

### å½“å‰æœ€ä¼˜é…ç½®

ç»è¿‡å…¨é¢æµ‹è¯•å’Œä¼˜åŒ–ï¼Œå½“å‰é…ç½®ï¼š

- **æ‰¹æ¬¡å¤§å°**: 96
- **æ¨¡å‹è§„æ¨¡**: 768/16å±‚/12å¤´
- **æ˜¾å­˜åˆ©ç”¨ç‡**: 83.6% (20.1 GB / 24 GB)
- **è®­ç»ƒé€Ÿåº¦**: ~42 ms/æ‰¹æ¬¡
- **ååé‡**: 1327 æ ·æœ¬/ç§’

### ä¼˜åŒ–å†…å®¹

1. **æ‰¹æ¬¡å¤§å°ä¼˜åŒ–**: 56 â†’ 96ï¼ˆæ˜¾å­˜åˆ©ç”¨ç‡ 51.7% â†’ 83.6%ï¼‰
2. **æ¨¡å‹è§„æ¨¡ä¼˜åŒ–**: 384/8å±‚ â†’ 768/16å±‚
3. **æ•°æ®åŠ è½½ä¼˜åŒ–**: num_workers=8, prefetch_factor=4
4. **æ¨¡å‹ç¼–è¯‘**: å¯ç”¨ torch.compile
5. **æ··åˆç²¾åº¦**: ä½¿ç”¨ BF16ï¼ˆæ›´ç¨³å®šï¼‰
6. **ä»£ç ä¼˜åŒ–**: åˆå¹¶ autocast ä¸Šä¸‹æ–‡ï¼Œéé˜»å¡ä¼ è¾“

### è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **ä½¿ç”¨ Flash Attention**ï¼ˆå¦‚æœæ”¯æŒï¼‰
2. **å¤š GPU è®­ç»ƒ**: ä½¿ç”¨ `accelerate config`
3. **æ¢¯åº¦æ£€æŸ¥ç‚¹**: å¦‚æœæ˜¾å­˜ä¸è¶³

è¯¦ç»†ä¼˜åŒ–è¯´æ˜è§ï¼š`PERFORMANCE_OPTIMIZATION.md`

---

## å¸¸è§é—®é¢˜

### è®­ç»ƒé—®é¢˜

**Q: æ˜¾å­˜ä¸è¶³ (OOM)**
- å‡å° `batch_size` åˆ° 80 æˆ– 64
- å¯ç”¨ VAE åˆ‡ç‰‡: `use_slicing: true`
- å‡å°æ¨¡å‹è§„æ¨¡

**Q: è®­ç»ƒé€Ÿåº¦æ…¢**
- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ GPU
- å¢åŠ  `num_workers`
- å¯ç”¨æ¨¡å‹ç¼–è¯‘: `compile_model: true`

**Q: æŸå¤±ä¸ä¸‹é™**
- æ£€æŸ¥å­¦ä¹ ç‡ï¼ˆå¯èƒ½éœ€è¦å‡å°ï¼‰
- æ£€æŸ¥æ•°æ®è´¨é‡
- æ£€æŸ¥æ¨¡å‹è¾“å‡º

### æ¨ç†é—®é¢˜

**Q: ç”Ÿæˆè´¨é‡å·®**
- å¢åŠ æ¨ç†æ­¥æ•°ï¼ˆ50 â†’ 100ï¼‰
- æ”¹è¿›æç¤ºè¯
- æ£€æŸ¥æ¨¡å‹è®­ç»ƒæ˜¯å¦å……åˆ†

**Q: æ£€æŸ¥ç‚¹åŠ è½½å¤±è´¥**
- æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®ä¿é…ç½®æ–‡ä»¶ä¸è®­ç»ƒæ—¶ä¸€è‡´

è¯¦ç»† FAQ è§ï¼š`docs/07-å¸¸è§é—®é¢˜.md`

---

## è¿›é˜¶å­¦ä¹ 

### æ¨¡å‹æ¶æ„

- DiT Transformer ç»“æ„
- æ¡ä»¶æ³¨å…¥æœºåˆ¶
- VAE ç¼–ç /è§£ç 
- æ‰©æ•£è¿‡ç¨‹

è¯¦ç»†è¯´æ˜è§ï¼š`docs/04-æ¨¡å‹æ¶æ„.md`

### è®­ç»ƒæŠ€å·§

- å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥
- æ•°æ®å¢å¼º
- æ­£åˆ™åŒ–æŠ€æœ¯
- æ—©åœæœºåˆ¶

### æ‰©å±•åº”ç”¨

- å›¾åƒç¼–è¾‘
- é£æ ¼è¿ç§»
- è§†é¢‘ç”Ÿæˆ
- 3D ç”Ÿæˆ

è¯¦ç»†å†…å®¹è§ï¼š`docs/08-è¿›é˜¶å­¦ä¹ .md`

---

## é¡¹ç›®ç»“æ„

```
t2i2/
â”œâ”€â”€ docs/                    # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ 00-å®Œæ•´æ•™ç¨‹.md      # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ 01-å…¥é—¨æŒ‡å—.md
â”‚   â”œâ”€â”€ 02-ç¯å¢ƒé…ç½®.md
â”‚   â”œâ”€â”€ 03-æ•°æ®å‡†å¤‡.md
â”‚   â”œâ”€â”€ 04-æ¨¡å‹æ¶æ„.md
â”‚   â”œâ”€â”€ 05-è®­ç»ƒæµç¨‹.md
â”‚   â”œâ”€â”€ 06-æ¨ç†ä½¿ç”¨.md
â”‚   â”œâ”€â”€ 07-å¸¸è§é—®é¢˜.md
â”‚   â””â”€â”€ 08-è¿›é˜¶å­¦ä¹ .md
â”‚
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ models/            # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ data/              # æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ training/          # è®­ç»ƒç›¸å…³
â”‚   â”œâ”€â”€ inference/         # æ¨ç†ç›¸å…³
â”‚   â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ scripts/          # å¯æ‰§è¡Œè„šæœ¬
â”‚
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ train_config.yaml  # è®­ç»ƒé…ç½®
â”‚
â”œâ”€â”€ requirements.txt       # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜
```

---

## å­¦ä¹ è·¯å¾„

### åˆå­¦è€…

1. é˜…è¯» [å…¥é—¨æŒ‡å—](./01-å…¥é—¨æŒ‡å—.md) äº†è§£åŸºæœ¬æ¦‚å¿µ
2. æŒ‰ç…§ [ç¯å¢ƒé…ç½®](./02-ç¯å¢ƒé…ç½®.md) æ­å»ºç¯å¢ƒ
3. ä½¿ç”¨ç¤ºä¾‹æ•°æ®è¿è¡Œè®­ç»ƒ
4. å°è¯•ç”Ÿæˆå›¾åƒ

### è¿›é˜¶ç”¨æˆ·

1. æ·±å…¥ç†è§£ [æ¨¡å‹æ¶æ„](./04-æ¨¡å‹æ¶æ„.md)
2. ä¼˜åŒ–è®­ç»ƒå‚æ•°
3. æ¢ç´¢ [è¿›é˜¶å­¦ä¹ ](./08-è¿›é˜¶å­¦ä¹ .md) å†…å®¹

---

## å‚è€ƒèµ„æº

### ç›¸å…³è®ºæ–‡

1. **DiT**: Scalable Diffusion Models with Transformers
2. **Stable Diffusion**: High-Resolution Image Synthesis with Latent Diffusion Models
3. **DDPM**: Denoising Diffusion Probabilistic Models

### å¼€æºé¡¹ç›®

1. [DiT (Facebook Research)](https://github.com/facebookresearch/DiT)
2. [Hugging Face Diffusers](https://github.com/huggingface/diffusers)
3. [Stable Diffusion](https://github.com/Stability-AI/stablediffusion)

---

## æ€»ç»“

æœ¬æ•™ç¨‹æä¾›äº†å®Œæ•´çš„ DiT æ–‡ç”Ÿå›¾å­¦ä¹ è·¯å¾„ï¼š

1. âœ… **ç¯å¢ƒé…ç½®** - æ­å»ºå¼€å‘ç¯å¢ƒ
2. âœ… **æ•°æ®å‡†å¤‡** - å‡†å¤‡è®­ç»ƒæ•°æ®
3. âœ… **æ¨¡å‹è®­ç»ƒ** - è®­ç»ƒ DiT æ¨¡å‹
4. âœ… **æ¨¡å‹æ¨ç†** - ç”Ÿæˆå›¾åƒ
5. âœ… **æ€§èƒ½ä¼˜åŒ–** - å……åˆ†åˆ©ç”¨ GPU
6. âœ… **é—®é¢˜è§£å†³** - å¸¸è§é—®é¢˜å¤„ç†

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼** ğŸ‰

---

**ä¸‹ä¸€æ­¥ï¼š**
- å¼€å§‹è®­ç»ƒä½ çš„ç¬¬ä¸€ä¸ªæ¨¡å‹
- ç”Ÿæˆä½ çš„ç¬¬ä¸€å¼ å›¾åƒ
- æ¢ç´¢æ›´å¤šå¯èƒ½æ€§

