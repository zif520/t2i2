# 03. æ•°æ®å‡†å¤‡

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•å‡†å¤‡è®­ç»ƒæ•°æ®ã€‚é¡¹ç›®æ”¯æŒä¸‰ç§æ•°æ®é›†ï¼šCOCOã€CUB-200-2011 å’Œè‡ªå®šä¹‰æ•°æ®é›†ã€‚

## ğŸ“Š æ•°æ®æ ¼å¼è¦æ±‚

### åŸºæœ¬è¦æ±‚

DiT æ¨¡å‹éœ€è¦**å›¾åƒ-æ–‡æœ¬å¯¹**æ•°æ®ï¼Œå³æ¯å¼ å›¾åƒå¯¹åº”ä¸€ä¸ªæ–‡æœ¬æè¿°ã€‚

**æ•°æ®æ ¼å¼**ï¼š
- **å›¾åƒ**ï¼šRGB æ ¼å¼ï¼Œæ¨èå°ºå¯¸ 256x256 æˆ–æ›´å¤§
- **æ–‡æœ¬**ï¼šè‹±æ–‡æè¿°ï¼Œé•¿åº¦å»ºè®®åœ¨ 10-100 ä¸ªè¯ä¹‹é—´

### é¡¹ç›®æ•°æ®æ ¼å¼

å¤„ç†åçš„æ•°æ®åº”ç»„ç»‡ä¸ºä»¥ä¸‹ç»“æ„ï¼š

```
data/
â”œâ”€â”€ {dataset_name}_subset/
â”‚   â”œâ”€â”€ metadata.json      # å…ƒæ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ images/            # å›¾åƒç›®å½•
â”‚       â”œâ”€â”€ image_000000.jpg
â”‚       â”œâ”€â”€ image_000001.jpg
â”‚       â””â”€â”€ ...
```

**metadata.json æ ¼å¼**ï¼š

```json
[
    {
        "image": "images/image_000000.jpg",
        "text": "a cat sitting on a chair"
    },
    {
        "image": "images/image_000001.jpg",
        "text": "a beautiful landscape with mountains"
    }
]
```

## ğŸ¯ æ•°æ®é›†é€‰æ‹©

### 1. COCO æ•°æ®é›†ï¼ˆæ¨èç”¨äºå­¦ä¹ ï¼‰

**ä¼˜ç‚¹**ï¼š
- å…¬å¼€å¯ç”¨
- è´¨é‡è¾ƒé«˜
- æ ‡æ³¨å®Œæ•´
- åŒ…å«ä¸°å¯Œçš„åœºæ™¯å’Œå¯¹è±¡

**è·å–æ–¹å¼**ï¼š
- ä½¿ç”¨ Hugging Face datasets åº“è‡ªåŠ¨ä¸‹è½½
- æˆ–ä» [COCO å®˜ç½‘](https://cocodataset.org/) æ‰‹åŠ¨ä¸‹è½½

### 2. CUB-200-2011 æ•°æ®é›†ï¼ˆç»†ç²’åº¦åˆ†ç±»ï¼‰

**ä¼˜ç‚¹**ï¼š
- 200 ç§é¸Ÿç±»
- æ¯å¼ å›¾åƒæœ‰è¯¦ç»†çš„æ–‡æœ¬æè¿°
- é€‚åˆç»†ç²’åº¦å›¾åƒç”Ÿæˆä»»åŠ¡

**è·å–æ–¹å¼**ï¼š
- ä» Kaggle ä¸‹è½½ï¼ˆæ¨èï¼‰
- æˆ–ä» Hugging Face ä¸‹è½½

### 3. è‡ªå®šä¹‰æ•°æ®é›†

**é€‚ç”¨åœºæ™¯**ï¼š
- ç‰¹å®šé¢†åŸŸçš„å›¾åƒç”Ÿæˆ
- ç‰¹å®šé£æ ¼çš„å›¾åƒç”Ÿæˆ
- è‡ªå·±çš„å›¾åƒ-æ–‡æœ¬å¯¹æ•°æ®

## ğŸ“¥ COCO æ•°æ®é›†å‡†å¤‡

### æ–¹æ³• 1: ä½¿ç”¨ Hugging Face è‡ªåŠ¨ä¸‹è½½ï¼ˆæ¨èï¼‰

```bash
python src/scripts/prepare_data.py \
    --type coco \
    --output ./data/coco_subset \
    --num_samples 5000
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- è‡ªåŠ¨ä» Hugging Face ä¸‹è½½ COCO æ•°æ®
- å¤„ç†å›¾åƒå’Œæ–‡æœ¬æè¿°
- è°ƒæ•´å›¾åƒå¤§å°åˆ° 256x256
- ä¿å­˜ä¸ºé¡¹ç›®éœ€è¦çš„æ ¼å¼

**å‚æ•°è¯´æ˜**ï¼š
- `--type`: æ•°æ®é›†ç±»å‹ï¼ˆ`coco`ï¼‰
- `--output`: è¾“å‡ºç›®å½•
- `--num_samples`: ä½¿ç”¨çš„æ ·æœ¬æ•°é‡

### æ–¹æ³• 2: æ‰‹åŠ¨ä¸‹è½½åå¤„ç†

å¦‚æœè‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½ï¼š

1. **ä¸‹è½½ COCO æ•°æ®**ï¼š
   - è®¿é—®ï¼šhttps://cocodataset.org/
   - ä¸‹è½½è®­ç»ƒå›¾åƒå’Œæ ‡æ³¨æ–‡ä»¶

2. **è§£å‹æ•°æ®**ï¼š
   ```bash
   unzip train2017.zip -d ./data/coco_raw/
   unzip annotations_trainval2017.zip -d ./data/coco_raw/
   ```

3. **å¤„ç†æ•°æ®**ï¼š
   ```bash
   python src/scripts/prepare_coco_from_download.py \
       --images_dir ./data/coco_raw/train2017 \
       --annotations_file ./data/coco_raw/annotations/captions_train2017.json \
       --output ./data/coco_subset \
       --num_samples 5000
   ```

## ğŸ¦ CUB-200-2011 æ•°æ®é›†å‡†å¤‡

### æ–¹æ³• 1: ä» Kaggle ä¸‹è½½ï¼ˆæ¨èï¼‰

1. **ä¸‹è½½æ•°æ®**ï¼š
   - è®¿é—® Kaggle: https://www.kaggle.com/datasets/wenewone/cub2002011
   - ä½¿ç”¨ `kagglehub` ä¸‹è½½ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ `down.py`ï¼‰

2. **å¤„ç†æ•°æ®**ï¼š
   ```bash
   python src/scripts/prepare_cub_from_kaggle.py \
       --kaggle_dir ./data/cub_raw/cub2002011 \
       --output ./data/cub_subset \
       --num_samples 5000
   ```

**è„šæœ¬åŠŸèƒ½**ï¼š
- è¯»å– Kaggle ç‰ˆæœ¬çš„ CUB æ•°æ®é›†
- æå–å›¾åƒå’Œæ–‡æœ¬æè¿°
- è°ƒæ•´å›¾åƒå¤§å°åˆ° 256x256
- ä¿å­˜ä¸ºé¡¹ç›®éœ€è¦çš„æ ¼å¼

### æ–¹æ³• 2: ä» Hugging Face ä¸‹è½½

```bash
python src/scripts/download_cub.py \
    --download \
    --output ./data/cub_subset \
    --num_samples 5000
```

**æ³¨æ„**: éœ€è¦è®¾ç½®ä»£ç†æˆ–é•œåƒï¼ˆè§ [02. å®‰è£…é…ç½®](./02-å®‰è£…é…ç½®.md#ç½‘ç»œé…ç½®)ï¼‰

## ğŸ¨ è‡ªå®šä¹‰æ•°æ®é›†å‡†å¤‡

### æ–¹æ³• 1: ä½¿ç”¨è„šæœ¬å¤„ç†

å¦‚æœä½ çš„æ•°æ®å·²ç»ç»„ç»‡ä¸ºå›¾åƒ-æ–‡æœ¬å¯¹ï¼š

```bash
python src/scripts/prepare_data.py \
    --type custom \
    --input ./my_data \
    --output ./data/custom_subset
```

**è¾“å…¥æ•°æ®æ ¼å¼**ï¼š

```
my_data/
â”œâ”€â”€ image1.jpg
â”œâ”€â”€ image1.txt        # å¯¹åº”çš„æ–‡æœ¬æè¿°
â”œâ”€â”€ image2.jpg
â”œâ”€â”€ image2.txt
â””â”€â”€ ...
```

### æ–¹æ³• 2: æ‰‹åŠ¨åˆ›å»º metadata.json

å¦‚æœä½ çš„æ•°æ®æ ¼å¼ä¸åŒï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»º `metadata.json`ï¼š

```json
[
    {
        "image": "images/image_000000.jpg",
        "text": "your text description here"
    },
    {
        "image": "images/image_000001.jpg",
        "text": "another text description"
    }
]
```

ç„¶åç»„ç»‡ç›®å½•ç»“æ„ï¼š

```
data/custom_subset/
â”œâ”€â”€ metadata.json
â””â”€â”€ images/
    â”œâ”€â”€ image_000000.jpg
    â”œâ”€â”€ image_000001.jpg
    â””â”€â”€ ...
```

## ğŸ” æ•°æ®é›†åŠ è½½

### åœ¨ä»£ç ä¸­ä½¿ç”¨

æ•°æ®é›†åŠ è½½ç”± `TextImageDataset` ç±»å¤„ç†ï¼ˆ`src/data/dataset.py`ï¼‰ï¼š

```python
from src.data.dataset import TextImageDataset

# åŠ è½½ COCO æ•°æ®é›†
dataset = TextImageDataset(
    dataset_name="coco",
    dataset_path="./data/coco_subset",
    image_size=256,
    num_samples=5000,
    is_train=True,
)

# åŠ è½½ CUB æ•°æ®é›†
dataset = TextImageDataset(
    dataset_name="cub",
    dataset_path="./data/cub_subset",
    image_size=256,
    num_samples=5000,
    is_train=True,
)

# åŠ è½½è‡ªå®šä¹‰æ•°æ®é›†
dataset = TextImageDataset(
    dataset_name="custom",
    dataset_path="./data/custom_subset",
    image_size=256,
    is_train=True,
)
```

### åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š

ç¼–è¾‘ `configs/train_config.yaml`ï¼š

```yaml
data:
  dataset_name: "coco"  # æˆ– "cub", "custom"
  dataset_path: "./data/coco_subset"
  num_samples: 5000
  image_size: 256
```

## ğŸ“ æ•°æ®é¢„å¤„ç†

### è‡ªåŠ¨é¢„å¤„ç†

æ•°æ®é›†åŠ è½½æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œä»¥ä¸‹é¢„å¤„ç†ï¼š

1. **å›¾åƒå˜æ¢**ï¼ˆ`src/data/transforms.py`ï¼‰ï¼š
   - è°ƒæ•´å¤§å°åˆ°æŒ‡å®šå°ºå¯¸ï¼ˆé»˜è®¤ 256x256ï¼‰
   - ä¸­å¿ƒè£å‰ª
   - éšæœºæ°´å¹³ç¿»è½¬ï¼ˆè®­ç»ƒæ—¶ï¼‰
   - å½’ä¸€åŒ–åˆ° [-1, 1] èŒƒå›´

2. **æ–‡æœ¬å¤„ç†**ï¼š
   - ä½¿ç”¨ CLIP tokenizer è¿›è¡Œåˆ†è¯
   - æˆªæ–­æˆ–å¡«å……åˆ°æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤ 77ï¼‰

### æ‰‹åŠ¨é¢„å¤„ç†

å¦‚æœéœ€è¦è‡ªå®šä¹‰é¢„å¤„ç†ï¼Œå¯ä»¥ä¿®æ”¹ `src/data/transforms.py` ä¸­çš„ `get_image_transforms` å‡½æ•°ã€‚

## âœ… éªŒè¯æ•°æ®

### æ£€æŸ¥æ•°æ®æ ¼å¼

```bash
# æ£€æŸ¥å…ƒæ•°æ®æ–‡ä»¶
python -c "import json; data = json.load(open('data/coco_subset/metadata.json')); print(f'æ ·æœ¬æ•°: {len(data)}'); print(f'ç¬¬ä¸€ä¸ªæ ·æœ¬: {data[0]}')"

# æ£€æŸ¥å›¾åƒ
ls -lh data/coco_subset/images/ | head -10
```

### å¯è§†åŒ–æ•°æ®

```python
from PIL import Image
import json

# åŠ è½½å…ƒæ•°æ®
with open('data/coco_subset/metadata.json', 'r') as f:
    metadata = json.load(f)

# æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ·æœ¬
item = metadata[0]
image = Image.open(f"data/coco_subset/{item['image']}")
print(f"æ–‡æœ¬: {item['text']}")
image.show()
```

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: ä¸‹è½½è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ä»£ç†ï¼š`export HTTP_PROXY=http://127.0.0.1:7890`
- ä½¿ç”¨é•œåƒï¼š`export HF_ENDPOINT=https://hf-mirror.com`
- å¢åŠ è¶…æ—¶ï¼š`export HF_HUB_DOWNLOAD_TIMEOUT=600`

### é—®é¢˜ 2: æ•°æ®æ ¼å¼é”™è¯¯

**ç—‡çŠ¶**: `ValueError: ä¸æ”¯æŒçš„æ•°æ®é›†: xxx`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `dataset_name` æ˜¯å¦ä¸º `"coco"`, `"cub"` æˆ– `"custom"`
- æ£€æŸ¥ `dataset_path` æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ `metadata.json` æ ¼å¼æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 3: å›¾åƒåŠ è½½å¤±è´¥

**ç—‡çŠ¶**: `FileNotFoundError` æˆ–å›¾åƒæŸå

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å›¾åƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥å›¾åƒè·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
- éªŒè¯å›¾åƒæ–‡ä»¶æ˜¯å¦æŸå

## ğŸ“ ä¸‹ä¸€æ­¥

- ğŸ“– [04. æ¨¡å‹æ¶æ„](./04-æ¨¡å‹æ¶æ„.md) - äº†è§£æ¨¡å‹ç»“æ„
- ğŸ“– [05. è®­ç»ƒæŒ‡å—](./05-è®­ç»ƒæŒ‡å—.md) - å¼€å§‹è®­ç»ƒ

---

**æ•°æ®å‡†å¤‡å®Œæˆ**: ç¡®ä¿ `metadata.json` å’Œ `images/` ç›®å½•éƒ½å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼
