# 06. æ¨ç†ä½¿ç”¨

æœ¬æŒ‡å—å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è®­ç»ƒå¥½çš„ DiT æ¨¡å‹ç”Ÿæˆå›¾åƒã€‚

## åŸºæœ¬ä½¿ç”¨

### ç”Ÿæˆå•å¼ å›¾åƒ

```bash
python src/scripts/inference.py \
    --config configs/train_config.yaml \
    --checkpoint ./outputs/checkpoint-5000 \
    --prompt "a cat sitting on a chair" \
    --output ./outputs/generated
```

### å‚æ•°è¯´æ˜

- `--config`ï¼šé…ç½®æ–‡ä»¶è·¯å¾„
- `--checkpoint`ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹ç›®å½•
- `--prompt`ï¼šæ–‡æœ¬æç¤º
- `--output`ï¼šè¾“å‡ºç›®å½•
- `--num_inference_steps`ï¼šæ¨ç†æ­¥æ•°ï¼ˆé»˜è®¤ 50ï¼‰
- `--height`ï¼šå›¾åƒé«˜åº¦ï¼ˆé»˜è®¤ 256ï¼‰
- `--width`ï¼šå›¾åƒå®½åº¦ï¼ˆé»˜è®¤ 256ï¼‰
- `--seed`ï¼šéšæœºç§å­ï¼ˆå¯é€‰ï¼‰

## æ¨ç†è¿‡ç¨‹

### 1. åŠ è½½æ¨¡å‹

```python
# åŠ è½½æ£€æŸ¥ç‚¹
model.load_state_dict(torch.load("checkpoint/model.pt"))
model.eval()
```

### 2. ç¼–ç æ–‡æœ¬

```python
# ä½¿ç”¨ CLIP tokenizer å’Œç¼–ç å™¨
text_inputs = tokenizer(prompt, ...)
text_embeddings = text_encoder(text_inputs.input_ids)
```

### 3. åˆå§‹åŒ–å™ªå£°

```python
# ä»éšæœºå™ªå£°å¼€å§‹
latents = torch.randn(1, 4, 32, 32)  # æ½œåœ¨ç©ºé—´å°ºå¯¸
```

### 4. æ‰©æ•£é‡‡æ ·

```python
for t in scheduler.timesteps:
    # é¢„æµ‹å™ªå£°
    noise_pred = model(latents, t, text_embeddings)
    # æ›´æ–°æ½œåœ¨è¡¨ç¤º
    latents = scheduler.step(noise_pred, t, latents).prev_sample
```

### 5. è§£ç å›¾åƒ

```python
# ä½¿ç”¨ VAE è§£ç 
images = vae_decoder.decode(latents)
# è½¬æ¢ä¸º PIL å›¾åƒ
image = tensor_to_pil_image(images[0])
```

## æ¨ç†å‚æ•°è°ƒä¼˜

### æ¨ç†æ­¥æ•° (num_inference_steps)

- **é»˜è®¤å€¼**ï¼š50
- **è¯´æ˜**ï¼šå»å™ªçš„æ­¥æ•°
- **å½±å“**ï¼š
  - æ›´å¤šæ­¥æ•°ï¼šè´¨é‡æ›´å¥½ï¼Œä½†é€Ÿåº¦æ›´æ…¢
  - æ›´å°‘æ­¥æ•°ï¼šé€Ÿåº¦æ›´å¿«ï¼Œä½†è´¨é‡å¯èƒ½ä¸‹é™
- **å»ºè®®**ï¼š
  - å¿«é€Ÿæµ‹è¯•ï¼š20-30 æ­¥
  - é«˜è´¨é‡ï¼š50-100 æ­¥

### å¼•å¯¼å¼ºåº¦ (guidance_scale)

- **é»˜è®¤å€¼**ï¼š7.5
- **è¯´æ˜**ï¼šæ–‡æœ¬æ¡ä»¶çš„å¼ºåº¦
- **å½±å“**ï¼š
  - æ›´é«˜ï¼šæ›´ç¬¦åˆæ–‡æœ¬ï¼Œä½†å¯èƒ½è¿‡åº¦é¥±å’Œ
  - æ›´ä½ï¼šæ›´è‡ªç„¶ï¼Œä½†å¯èƒ½åç¦»æ–‡æœ¬
- **å»ºè®®èŒƒå›´**ï¼š5.0 - 15.0

### å›¾åƒå°ºå¯¸

- **é»˜è®¤å€¼**ï¼š256x256
- **è¯´æ˜**ï¼šç”Ÿæˆå›¾åƒçš„åˆ†è¾¨ç‡
- **æ³¨æ„**ï¼šå¿…é¡»ä¸è®­ç»ƒæ—¶çš„å°ºå¯¸åŒ¹é…ï¼ˆæˆ–æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼‰

## æ‰¹é‡ç”Ÿæˆ

### ä½¿ç”¨è„šæœ¬

ä¿®æ”¹è„šæœ¬æ”¯æŒæ‰¹é‡ç”Ÿæˆï¼Œæˆ–å¤šæ¬¡è°ƒç”¨ï¼š

```bash
# ç”Ÿæˆå¤šå¼ å›¾åƒ
for prompt in "cat" "dog" "bird"; do
    python src/scripts/inference.py \
        --checkpoint ./outputs/checkpoint-5000 \
        --prompt "$prompt" \
        --output ./outputs/generated
done
```

### ä½¿ç”¨ä»£ç 

```python
from src.inference.generator import ImageGenerator

generator = ImageGenerator(...)

prompts = [
    "a cat sitting on a chair",
    "a dog playing in the park",
    "a beautiful landscape",
]

images = generator.generate_batch(prompts)
```

## æç¤ºè¯æŠ€å·§

### å¥½çš„æç¤ºè¯

- **å…·ä½“æè¿°**ï¼š"a red cat sitting on a wooden chair"
- **åŒ…å«ç»†èŠ‚**ï¼š"a cat with green eyes, sitting on a chair, indoor lighting"
- **æŒ‡å®šé£æ ¼**ï¼š"a cat sitting on a chair, oil painting style"

### é¿å…çš„æç¤ºè¯

- **è¿‡äºç®€å•**ï¼š"cat"ï¼ˆå¤ªæ¨¡ç³Šï¼‰
- **è¿‡äºå¤æ‚**ï¼šåŒ…å«å¤ªå¤šä¸ç›¸å…³çš„ç»†èŠ‚
- **çŸ›ç›¾æè¿°**ï¼šç›¸äº’å†²çªçš„æè¿°

### æç¤ºè¯æ¨¡æ¿

```
[ä¸»ä½“] + [åŠ¨ä½œ/çŠ¶æ€] + [ç¯å¢ƒ] + [é£æ ¼/è´¨é‡]
```

ç¤ºä¾‹ï¼š
- "a cat sitting on a chair, indoor, photorealistic"
- "a landscape with mountains, sunset, oil painting"

## ç»“æœä¼˜åŒ–

### 1. è°ƒæ•´æ¨ç†æ­¥æ•°

å¦‚æœç»“æœä¸ç†æƒ³ï¼Œå°è¯•å¢åŠ æ­¥æ•°ï¼š

```bash
--num_inference_steps 100
```

### 2. è°ƒæ•´å¼•å¯¼å¼ºåº¦

å¦‚æœå›¾åƒè¿‡äºé¥±å’Œæˆ–ä¸ç¬¦åˆæ–‡æœ¬ï¼š

```bash
# é™ä½å¼•å¯¼å¼ºåº¦
--guidance_scale 5.0

# æˆ–æé«˜å¼•å¯¼å¼ºåº¦
--guidance_scale 10.0
```

### 3. ä½¿ç”¨ä¸åŒçš„éšæœºç§å­

```bash
# ç”Ÿæˆå¤šä¸ªå˜ä½“
for seed in 1 2 3 4 5; do
    python src/scripts/inference.py \
        --checkpoint ./outputs/checkpoint-5000 \
        --prompt "a cat" \
        --seed $seed
done
```

## æ€§èƒ½ä¼˜åŒ–

### ä½¿ç”¨ DDIM è°ƒåº¦å™¨

DDIM å¯ä»¥æ›´å¿«ç”Ÿæˆï¼š

```python
generator = ImageGenerator(
    ...,
    scheduler_type="ddim",  # ä½¿ç”¨ DDIM
)
```

### å‡å°‘æ¨ç†æ­¥æ•°

å¯¹äºå¿«é€Ÿæµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨æ›´å°‘çš„æ­¥æ•°ï¼š

```bash
--num_inference_steps 20
```

### æ‰¹é‡æ¨ç†

å¦‚æœç”Ÿæˆå¤šå¼ å›¾åƒï¼Œä½¿ç”¨æ‰¹é‡æ¨ç†æ›´é«˜æ•ˆã€‚

## å¸¸è§é—®é¢˜

### 1. ç”Ÿæˆè´¨é‡å·®

**å¯èƒ½åŸå› ï¼š**
- æ¨¡å‹è®­ç»ƒä¸å……åˆ†
- æç¤ºè¯ä¸åˆé€‚
- æ¨ç†æ­¥æ•°å¤ªå°‘

**è§£å†³æ–¹æ¡ˆï¼š**
- ç»§ç»­è®­ç»ƒæ¨¡å‹
- æ”¹è¿›æç¤ºè¯
- å¢åŠ æ¨ç†æ­¥æ•°

### 2. ç”Ÿæˆé€Ÿåº¦æ…¢

**å¯èƒ½åŸå› ï¼š**
- æ¨ç†æ­¥æ•°å¤ªå¤š
- æ²¡æœ‰ä½¿ç”¨ GPU
- æ¨¡å‹å¤ªå¤§

**è§£å†³æ–¹æ¡ˆï¼š**
- å‡å°‘æ¨ç†æ­¥æ•°
- ç¡®ä¿ä½¿ç”¨ GPU
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹

### 3. å†…å­˜ä¸è¶³

**å¯èƒ½åŸå› ï¼š**
- å›¾åƒå°ºå¯¸å¤ªå¤§
- æ‰¹æ¬¡å¤ªå¤§

**è§£å†³æ–¹æ¡ˆï¼š**
- å‡å°å›¾åƒå°ºå¯¸
- å•å¼ ç”Ÿæˆ

## è¯„ä¼°ç”Ÿæˆç»“æœ

### ä¸»è§‚è¯„ä¼°

- **æ–‡æœ¬ä¸€è‡´æ€§**ï¼šå›¾åƒæ˜¯å¦ç¬¦åˆæ–‡æœ¬æè¿°
- **è§†è§‰è´¨é‡**ï¼šå›¾åƒæ˜¯å¦æ¸…æ™°ã€è‡ªç„¶
- **å¤šæ ·æ€§**ï¼šä¸åŒæç¤ºè¯æ˜¯å¦ç”Ÿæˆä¸åŒå›¾åƒ

### å®¢è§‚æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰

- **FID**ï¼šFrÃ©chet Inception Distance
- **IS**ï¼šInception Score
- **CLIP Score**ï¼šæ–‡æœ¬-å›¾åƒç›¸ä¼¼åº¦

## ä¸‹ä¸€æ­¥

ç”Ÿæˆå›¾åƒåï¼Œå¯ä»¥ï¼š

1. è¯„ä¼°ç”Ÿæˆè´¨é‡
2. è°ƒæ•´æ¨¡å‹ç»§ç»­è®­ç»ƒ
3. å°è¯•ä¸åŒçš„æç¤ºè¯
4. é˜…è¯» [è¿›é˜¶å­¦ä¹ ](./08-è¿›é˜¶å­¦ä¹ .md) äº†è§£æ›´å¤š

---

**å¼€å§‹ç”Ÿæˆä½ çš„ç¬¬ä¸€å¼ å›¾åƒå§ï¼** ğŸ¨



