# 07. 常见问题

本文档收集了训练和使用 DiT 模型时遇到的常见问题及解决方案。

## 环境问题

### Q1: CUDA 不可用

**问题**：`torch.cuda.is_available()` 返回 `False`

**解决方案**：
1. 检查 NVIDIA 驱动：
   ```bash
   nvidia-smi
   ```
2. 检查 CUDA 版本是否匹配：
   ```bash
   nvcc --version
   ```
3. 重新安装匹配的 PyTorch：
   ```bash
   pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
   ```

### Q2: 依赖安装失败

**问题**：安装 requirements.txt 时出错

**解决方案**：
1. 使用虚拟环境：
   ```bash
   conda create -n dit python=3.10
   conda activate dit
   ```
2. 逐个安装依赖：
   ```bash
   pip install torch
   pip install diffusers
   pip install transformers
   ```
3. 检查 Python 版本（需要 3.8+）

## 训练问题

### Q3: 显存不足 (OOM)

**问题**：训练时出现 `CUDA out of memory` 错误

**解决方案**：
1. **减小批次大小**：
   ```yaml
   training:
     batch_size: 2  # 从 4 减小到 2
   ```

2. **增加梯度累积**：
   ```yaml
   training:
     gradient_accumulation_steps: 8  # 从 4 增加到 8
   ```

3. **启用混合精度**：
   ```yaml
   training:
     mixed_precision: "fp16"
   ```

4. **启用 VAE 切片**：
   ```yaml
   vae:
     use_slicing: true
   ```

5. **减小图像尺寸**：
   ```yaml
   data:
     image_size: 128  # 从 256 减小到 128
   ```

### Q4: 训练速度慢

**问题**：训练速度很慢

**解决方案**：
1. **检查是否使用 GPU**：
   ```python
   print(torch.cuda.is_available())
   ```

2. **增加数据加载线程**：
   ```python
   DataLoader(..., num_workers=4)
   ```

3. **启用混合精度训练**：
   ```yaml
   training:
     mixed_precision: "fp16"
   ```

4. **使用编译优化**（PyTorch 2.0+）：
   ```python
   model = torch.compile(model)
   ```

### Q5: 损失不下降

**问题**：训练时损失值不下降或上升

**解决方案**：
1. **检查学习率**：
   - 如果太大：减小学习率（如 5e-5）
   - 如果太小：增加学习率（如 2e-4）

2. **检查数据**：
   - 确认数据加载正确
   - 检查图像和文本是否匹配

3. **检查模型输出**：
   ```python
   print(model(x, t, y).shape)
   print(model(x, t, y).min(), model(x, t, y).max())
   ```

4. **使用梯度裁剪**：
   ```yaml
   training:
     max_grad_norm: 1.0
   ```

### Q6: 训练中断后如何恢复

**问题**：训练中断，如何从检查点恢复

**解决方案**：
```bash
python src/scripts/train.py \
    --config configs/train_config.yaml \
    --resume ./outputs/checkpoint-1000
```

确保检查点目录包含：
- `model.pt`
- `optimizer.pt`
- `training_state.json`

## 数据问题

### Q7: 数据加载失败

**问题**：无法加载数据集

**解决方案**：
1. **检查数据路径**：
   ```python
   from pathlib import Path
   print(Path("./data").exists())
   ```

2. **检查 JSON 格式**：
   ```python
   import json
   with open("data/metadata.json") as f:
       data = json.load(f)
   ```

3. **检查图像文件**：
   ```python
   from PIL import Image
   img = Image.open("data/images/image_000001.jpg")
   ```

### Q8: 内存不足（数据加载）

**问题**：加载数据时内存不足

**解决方案**：
1. **减少样本数量**：
   ```yaml
   data:
     num_samples: 1000  # 从 5000 减少
   ```

2. **减小图像尺寸**：
   ```yaml
   data:
     image_size: 128
   ```

3. **减少数据加载线程**：
   ```python
   DataLoader(..., num_workers=1)
   ```

## 推理问题

### Q9: 生成质量差

**问题**：生成的图像质量不好

**解决方案**：
1. **增加推理步数**：
   ```bash
   --num_inference_steps 100
   ```

2. **改进提示词**：
   - 使用更具体的描述
   - 包含更多细节

3. **检查模型训练是否充分**：
   - 确认训练了足够的轮数
   - 检查训练损失是否收敛

### Q10: 生成速度慢

**问题**：生成图像很慢

**解决方案**：
1. **减少推理步数**：
   ```bash
   --num_inference_steps 20
   ```

2. **使用 DDIM 调度器**：
   ```python
   generator = ImageGenerator(..., scheduler_type="ddim")
   ```

3. **确保使用 GPU**：
   ```python
   device = torch.device("cuda")
   ```

### Q11: 生成结果不一致

**问题**：相同提示词生成不同结果

**解决方案**：
这是正常的！扩散模型是随机的。如果需要可重复的结果：

```bash
--seed 42  # 使用固定种子
```

## 模型问题

### Q12: 模型加载失败

**问题**：无法加载检查点

**解决方案**：
1. **检查文件路径**：
   ```python
   from pathlib import Path
   checkpoint = Path("./outputs/checkpoint-1000/model.pt")
   print(checkpoint.exists())
   ```

2. **检查模型架构匹配**：
   - 确保配置文件与训练时一致
   - 检查模型参数是否匹配

3. **检查 PyTorch 版本**：
   - 不同版本可能不兼容

### Q13: 模型太大

**问题**：模型文件很大

**解决方案**：
1. **使用模型压缩**：
   ```python
   torch.save(model.state_dict(), "model.pt", _use_new_zipfile_serialization=False)
   ```

2. **只保存必要参数**：
   ```python
   torch.save({
       "model": model.state_dict(),
   }, "checkpoint.pt")
   ```

## 其他问题

### Q14: 如何调整模型大小

**问题**：想使用更大的模型

**解决方案**：
修改配置文件：

```yaml
model:
  hidden_size: 768    # 从 384 增加到 768
  num_layers: 12      # 从 8 增加到 12
  num_heads: 12       # 从 6 增加到 12
```

**注意**：增大模型会显著增加显存需求。

### Q15: 如何保存和分享模型

**问题**：如何保存和分享训练好的模型

**解决方案**：
1. **保存完整检查点**：
   ```python
   trainer.save_checkpoint("./outputs/final")
   ```

2. **上传到 Hugging Face**（可选）：
   ```python
   from huggingface_hub import HfApi
   api = HfApi()
   api.upload_folder(
       folder_path="./outputs/final",
       repo_id="your-username/dit-model",
   )
   ```

### Q16: 如何评估模型性能

**问题**：如何评估生成质量

**解决方案**：
1. **主观评估**：
   - 人工查看生成结果
   - 评估文本一致性和视觉质量

2. **客观指标**（需要额外代码）：
   - FID (Fréchet Inception Distance)
   - IS (Inception Score)
   - CLIP Score

## 获取帮助

如果以上解决方案都无法解决问题：

1. **检查日志**：查看训练日志中的错误信息
2. **查看文档**：阅读相关文档章节
3. **搜索问题**：在 GitHub Issues 中搜索类似问题
4. **提交 Issue**：提供详细的错误信息和环境信息

## 调试技巧

### 启用详细日志

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 检查中间输出

```python
# 在模型 forward 中添加打印
print(f"Input shape: {x.shape}")
print(f"Output shape: {output.shape}")
```

### 使用调试器

```python
import pdb
pdb.set_trace()  # 设置断点
```

---

**希望这些解决方案能帮助你！** 💡



